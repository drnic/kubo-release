---
<%
nats_ips = nil
if_p('nats.machines') do |ips|
  nats_ips = ips.compact
end.else do
  nats_ips = link('nats').instances.map { |instance| instance.address }
end

nats_port = nil
if_p('nats.port') do |prop|
  nats_port = prop
end.else do
  nats_port = link('nats').p("nats.port")
end
nats_user = nil
if_p('nats.user') do |prop|
  nats_user = prop
end.else do
  nats_user = link('nats').p("nats.user")
end
nats_password = nil
if_p('nats.password') do |prop|
  nats_password = prop
end.else do
  nats_password = link('nats').p("nats.password")
end
%>

nats_servers:
<% nats_ips.each do |ip| %>
   - host: <%="#{ip}:#{nats_port}" %>
     user: <%=nats_user %>
     password: <%=nats_password %>
<% end %>

<%
routing_api_client = p("cloud_foundry.routing_api_client_id")
api_url = uaa_url = app_domain = routing_api_client_secret = nil
skip_tls_verification = false # default from spec file
if_link("routing_api") do |routing|
  routing_api_client_secret = routing.p("routing_api.clients")[routing_api_client]["secret"]
end
if_link("cloud_controller") do |cc|
  system_domain = cc.p("system_domain")
  api_url = "https://api.#{system_domain}"
  uaa_url = "https://uaa.#{system_domain}"
  skip_tls_verification = true # currently default to true as 'skip_tls_verification' not provided in link
  app_domain = cc.p("app_domains").first
end
%>
app_domain_name: <%= p("cloud_foundry.app_domain", app_domain) %>
uaa_api_url: <%= p("cloud_foundry.uaa_url", uaa_url) %>
routing_api_url: <%= p("cloud_foundry.routing_api_url", api_url) %>
routing_api_username: <%= routing_api_client %>
routing_api_client_secret: <%= p("cloud_foundry.routing_api_client_secret", routing_api_client_secret) %>
skip_tls_verification: <%= p("cloud_foundry.skip_tls_verification", skip_tls_verification) %>
kube_config_path: /var/vcap/jobs/route-sync/config/kubeconfig
